
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Using GLS in R &#8212; Estimating Covariance Structures and Generalised Least Squares</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/test.css?v=a80109f0" />
    <link rel="stylesheet" type="text/css" href="_static/sphericity_3d_files/rglwidgetClass-1.3.18/rgl.css?v=57907efa" />
    <link rel="stylesheet" type="text/css" href="_static/sphericity_3d_files/htmltools-fill-0.5.8.1/fill.css?v=971cc1da" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '4.gls-R';</script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/textures.src.js?v=9482728f"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/shadersrc.src.js?v=6ce05c17"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/buffer.src.js?v=1efca185"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/mouse.src.js?v=96f0b970"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/projection.src.js?v=98871b91"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/axes.src.js?v=3250d244"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/rglTimer.src.js?v=ac1c3151"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/pretty.src.js?v=4f2cffba"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/shaders.src.js?v=bbbdf37d"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/animation.src.js?v=74f9b9e8"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/pieces.src.js?v=280fd571"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/selection.src.js?v=5b47ed7d"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/init.src.js?v=f5bdcbbb"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/subscenes.src.js?v=42cb429d"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/controls.src.js?v=4b3dbe6f"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/draw.src.js?v=49d9cbaa"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/utils.src.js?v=56efe719"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/rglClass.src.js?v=9e593197"></script>
    <script src="_static/sphericity_3d_files/rglWebGL-binding-1.3.18/rglWebGL.js?v=8cd6f6d7"></script>
    <script src="_static/sphericity_3d_files/htmlwidgets-1.6.4/htmlwidgets.js?v=175713be"></script>
    <script src="_static/sphericity_3d_files/CanvasMatrix4-1.3.18/CanvasMatrix.src.js?v=5a2d04be"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Limitations of the GLS Framework" href="5.gls-limitations.html" />
    <link rel="prev" title="Generalised Least Squares (GLS)" href="3.gls.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="0.intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Estimating Covariance Structures and Generalised Least Squares - Home"/>
    <img src="_static/logo.png" class="logo__image only-dark pst-js-only" alt="Estimating Covariance Structures and Generalised Least Squares - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="0.intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1.estimating-sigma.html">Estimating Covariance Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="2.covariance-solutions.html">Solutions for Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="3.gls.html">Generalised Least Squares (GLS)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Using GLS in <code class="docutils literal notranslate"><span class="pre">R</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="5.gls-limitations.html">Limitations of the GLS Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="summary.html">Summary</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/PCHN63112-Mixed-Models/estimating-covariance-gls" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/PCHN63112-Mixed-Models/estimating-covariance-gls/issues/new?title=Issue%20on%20page%20%2F4.gls-R.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/4.gls-R.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Using GLS in R</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-gls-one-way-anova">The GLS One-way ANOVA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-data">The Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-gls-syntax">The <code class="docutils literal notranslate"><span class="pre">gls()</span></code> Syntax</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-form-syntax">Understanding the <code class="docutils literal notranslate"><span class="pre">form=</span></code> Syntax</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-fully-unconstrained-covariance-structure">The Fully Unconstrained Covariance Structure</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assumptions-and-visualisations">Assumptions and Visualisations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assumptions-plots">Assumptions Plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualising-the-model">Visualising the Model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inference-using-gls">Inference Using <code class="docutils literal notranslate"><span class="pre">gls()</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coefficient-tests">Coefficient Tests</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#omnibus-tests">Omnibus Tests</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#follow-up-tests">Follow-up Tests</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#viewing-the-complete-covariance-structure">Viewing the Complete Covariance Structure</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="using-gls-in-r">
<h1>Using GLS in <code class="docutils literal notranslate"><span class="pre">R</span></code><a class="headerlink" href="#using-gls-in-r" title="Link to this heading">#</a></h1>
<p>In the previous part of this lesson, we discussed the theory behind GLS. Now we turn to how GLS is implemented within <code class="docutils literal notranslate"><span class="pre">R</span></code>. We saw some examples of using the <code class="docutils literal notranslate"><span class="pre">gls()</span></code> function from <code class="docutils literal notranslate"><span class="pre">nlme</span></code> last semester. At that point, we only focused on the use of the <code class="docutils literal notranslate"><span class="pre">weights=</span></code> argument with different variance structures (e.g. <code class="docutils literal notranslate"><span class="pre">varIdent()</span></code>, <code class="docutils literal notranslate"><span class="pre">varPower()</span></code> etc.). However, there is also a <code class="docutils literal notranslate"><span class="pre">correlation=</span></code> argument that similarly takes a number of pre-specified correlation structures. We can use these two arguments together to form a final variance-covariance matrix that consists of <em>both</em> correlation and heterogenous variance groups. In this part of the lesson, we will explore <code class="docutils literal notranslate"><span class="pre">gls()</span></code> further using a simple repeated measures one-way ANOVA model. We will see examples of using <code class="docutils literal notranslate"><span class="pre">gls()</span></code> on more complex datasets in the workshop this week.</p>
<section id="the-gls-one-way-anova">
<h2>The GLS One-way ANOVA<a class="headerlink" href="#the-gls-one-way-anova" title="Link to this heading">#</a></h2>
<section id="the-data">
<h3>The Data<a class="headerlink" href="#the-data" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">datarium</span></code> package contains a dataset called <code class="docutils literal notranslate"><span class="pre">selfesteem</span></code> that contains measurements of a self-esteem score taken at 3 different time points per-subject. We can see how this is structured below</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="s">&#39;datarium&#39;</span><span class="p">)</span>
<span class="nf">data</span><span class="p">(</span><span class="s">&#39;selfesteem&#39;</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">selfesteem</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  id       t1       t2       t3
1  1 4.005027 5.182286 7.107831
2  2 2.558124 6.912915 6.308434
3  3 3.244241 4.443434 9.778410
4  4 3.419538 4.711696 8.347124
5  5 2.871243 3.908429 6.457287
6  6 2.045868 5.340549 6.653224
</pre></div>
</div>
</div>
</div>
<p>We can then convert it to long-format to make it suitable for univariate modelling</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="s">&#39;reshape2&#39;</span><span class="p">)</span>

<span class="c1"># repeats and number of subjects</span>
<span class="n">t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">3</span>
<span class="n">n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">dim</span><span class="p">(</span><span class="n">selfesteem</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span>

<span class="c1"># reshape wide -&gt; long</span>
<span class="n">selfesteem.long</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">melt</span><span class="p">(</span><span class="n">selfesteem</span><span class="p">,</span><span class="w">            </span><span class="c1"># wide data frame</span>
<span class="w">                        </span><span class="n">id.vars</span><span class="o">=</span><span class="s">&#39;id&#39;</span><span class="p">,</span><span class="w">          </span><span class="c1"># what stays fixed?</span>
<span class="w">                        </span><span class="n">variable.name</span><span class="o">=</span><span class="s">&quot;time&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># name for the new predictor</span>
<span class="w">                        </span><span class="n">value.name</span><span class="o">=</span><span class="s">&quot;score&quot;</span><span class="p">)</span><span class="w">    </span><span class="c1"># name for the new outcome</span>

<span class="n">selfesteem.long</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">selfesteem.long</span><span class="p">[</span><span class="nf">order</span><span class="p">(</span><span class="n">selfesteem.long</span><span class="o">$</span><span class="n">id</span><span class="p">),]</span><span class="w"> </span><span class="c1"># order by ID</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">selfesteem.long</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">n</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="w">                        </span><span class="c1"># fix row names</span>
<span class="n">selfesteem.long</span><span class="o">$</span><span class="n">id</span><span class="w">        </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.factor</span><span class="p">(</span><span class="n">selfesteem.long</span><span class="o">$</span><span class="n">id</span><span class="p">)</span><span class="w">     </span><span class="c1"># convert ID to factor</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">head</span><span class="p">(</span><span class="n">selfesteem.long</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  id time    score
1  1   t1 4.005027
2  1   t2 5.182286
3  1   t3 7.107831
4  2   t1 2.558124
5  2   t2 6.912915
6  2   t3 6.308434
</pre></div>
</div>
</div>
</div>
<p>Our aim will be to look at different ways of modelling the covariance structure within this dataset, using GLS. In general, because there are 3 repeated measurements, the covariance matrix for each subject will be <span class="math notranslate nohighlight">\(3 \times 3\)</span>. Because we always assume that the subject are independent, we will be working with a block-diagonal structure of the form</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\text{Var}\left(\boldsymbol{\epsilon}\right) = 
\begin{bmatrix}
    \boldsymbol{\Sigma}_{1} &amp; \mathbf{0}              &amp; \mathbf{0}              &amp; \cdots &amp; \mathbf{0}              \\
    \mathbf{0}              &amp; \boldsymbol{\Sigma}_{2} &amp; \mathbf{0}              &amp; \cdots &amp; \mathbf{0}              \\
    \mathbf{0}              &amp; \mathbf{0}              &amp; \boldsymbol{\Sigma}_{3} &amp; \cdots &amp; \mathbf{0}              \\
    \vdots                  &amp; \vdots                  &amp; \vdots                  &amp; \ddots &amp; \vdots                  \\          
    \mathbf{0}              &amp; \mathbf{0}              &amp; \mathbf{0}              &amp; \cdots &amp; \boldsymbol{\Sigma}_{n} \\
\end{bmatrix},
\end{split}\]</div>
<p>where each <span class="math notranslate nohighlight">\(\boldsymbol{\Sigma}_{i}\)</span> is an <em>identical</em> <span class="math notranslate nohighlight">\(3 \times 3\)</span> matrix and each <span class="math notranslate nohighlight">\(\mathbf{0}\)</span> is a <span class="math notranslate nohighlight">\(3 \times 3\)</span> matrix of zeros. As such, for subject <span class="math notranslate nohighlight">\(i\)</span>, our decisions centre on how the following matrix is parameterised</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\boldsymbol{\Sigma}_{i} = 
\begin{bmatrix}
    \sigma^{2}_{1} &amp; \sigma_{12}    &amp; \sigma_{13}    \\
    \sigma_{12}    &amp; \sigma^{2}_{2} &amp; \sigma_{23}    \\
    \sigma_{13}    &amp; \sigma_{23}    &amp; \sigma^{2}_{3} \\
\end{bmatrix}.
\end{split}\]</div>
</section>
<section id="the-gls-syntax">
<h3>The <code class="docutils literal notranslate"><span class="pre">gls()</span></code> Syntax<a class="headerlink" href="#the-gls-syntax" title="Link to this heading">#</a></h3>
<p>… The equivalent model to the repeated measures ANOVA would be</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="s">&#39;nlme&#39;</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="s">&#39;Matrix&#39;</span><span class="p">)</span>

<span class="n">gls.mod.CompSymm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">gls</span><span class="p">(</span><span class="n">score</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">correlation</span><span class="o">=</span><span class="nf">corCompSymm</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="o">|</span><span class="n">id</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">selfesteem.long</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">gls.mod.CompSymm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Generalized least squares fit by REML
  Model: score ~ time 
  Data: selfesteem.long 
  Log-restricted-likelihood: -38.00009

Coefficients:
(Intercept)      timet2      timet3 
   3.140122    1.793820    4.496220 

Correlation Structure: Compound symmetry
 Formula: ~1 | id 
 Parameter estimate(s):
       Rho 
-0.1765313 
Degrees of freedom: 30 total; 27 residual
Residual standard error: 0.8859852 
</pre></div>
</div>
</div>
</div>
<p>… We can therefore view <span class="math notranslate nohighlight">\(\hat{\boldsymbol{\Sigma}_{i}}\)</span> for a given subject. For instance, the estimated covariance structure for the subject with <code class="docutils literal notranslate"><span class="pre">id</span> <span class="pre">=</span> <span class="pre">'1'</span></code> is</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Sigma.i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">getVarCov</span><span class="p">(</span><span class="n">gls.mod.CompSymm</span><span class="p">,</span><span class="w"> </span><span class="n">individual</span><span class="o">=</span><span class="s">&#39;1&#39;</span><span class="p">)</span><span class="w"> </span><span class="c1"># get covariance</span>
<span class="nf">print</span><span class="p">(</span><span class="n">Sigma.i</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Marginal variance covariance matrix
         [,1]     [,2]     [,3]
[1,]  0.78497 -0.13857 -0.13857
[2,] -0.13857  0.78497 -0.13857
[3,] -0.13857 -0.13857  0.78497
  Standard Deviations: 0.88599 0.88599 0.88599 
</pre></div>
</div>
</div>
</div>
<p>So here we can actually <em>see</em> the compound symmetric structure, as all the diagonal elements are the same and all the off-diagonal elements are the same. It can also be useful to <em>visualise</em> this matrix, to make the structure clear. To do so, we load the <code class="docutils literal notranslate"><span class="pre">Matrix</span></code> package to convert the output of <code class="docutils literal notranslate"><span class="pre">getVarCov()</span></code> to a <code class="docutils literal notranslate"><span class="pre">Matrix</span></code> and then visualise it with the <code class="docutils literal notranslate"><span class="pre">image</span></code> function</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">image</span><span class="p">(</span><span class="nf">as</span><span class="p">(</span><span class="n">Sigma.i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Matrix&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2ab3caf4ffd9d488c968743a68e740d2e418d3a4c5657f06d1bbe1109b62dbd7.png" src="_images/2ab3caf4ffd9d488c968743a68e740d2e418d3a4c5657f06d1bbe1109b62dbd7.png" />
</div>
</div>
</section>
<section id="understanding-the-form-syntax">
<h3>Understanding the <code class="docutils literal notranslate"><span class="pre">form=</span></code> Syntax<a class="headerlink" href="#understanding-the-form-syntax" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">form=</span></code> syntax can take a little getting used to, but it is worth making an effort to understand because this is <em>the</em> way that the structure of the covariance matrix is defined. To facilitate this, we will use the <code class="docutils literal notranslate"><span class="pre">corSymm()</span></code> function as an example, because this defines a <em>completely unstructured</em> covariance matrix. As such, the way that <code class="docutils literal notranslate"><span class="pre">form=</span></code> is written will fully determine how this matrix is estimated.</p>
<p>To begin with, the most basic structure would be <code class="docutils literal notranslate"><span class="pre">form=</span> <span class="pre">~</span> <span class="pre">1|id</span></code>. Here, the factor on the <em>right-hand</em> side of <code class="docutils literal notranslate"><span class="pre">|</span></code> defines the <em>blocks</em>. So each level of <code class="docutils literal notranslate"><span class="pre">id</span></code> defines a separate independent block and we have implied a block-diagonal structure to the covariance matrix. The variable on the <em>left-hand</em> side of <code class="docutils literal notranslate"><span class="pre">|</span></code> defines the structure <em>within</em> each block. If we just use <code class="docutils literal notranslate"><span class="pre">1</span></code> here, it implies a completely <em>unstructured</em> approach where every element is estimated separately. So, <code class="docutils literal notranslate"><span class="pre">1|id</span></code> means “estimate a completely unconstrained covariance block for each subject”.</p>
<p>Now, imagine the situation where the repeated measurements are taken across time. If we have multiple replications at each time-point (e.g. each subject was measured 4 times at each time-point) then this provides the opportunity for additional structure. For instance, we can specify <code class="docutils literal notranslate"><span class="pre">form=</span> <span class="pre">~</span> <span class="pre">time|id</span></code>, which still defines a blocked structure, but within each block we are saying that the variable <code class="docutils literal notranslate"><span class="pre">time</span></code> defines our <em>occasion</em> or <em>order</em>. If we do this, the covariance structure within a block will be defined in terms of <code class="docutils literal notranslate"><span class="pre">time</span></code>, so that the replications at each time-point would share a correlation. If we instead specified <code class="docutils literal notranslate"><span class="pre">form=</span> <span class="pre">~</span> <span class="pre">1|id</span></code> then each block would be <em>fully unconstrained</em>. So, every pair of replications within each time-point would have a different correlation. If we had <em>no</em> replications at each time-points, then <code class="docutils literal notranslate"><span class="pre">form=</span> <span class="pre">~</span> <span class="pre">time|id</span></code> and <code class="docutils literal notranslate"><span class="pre">form=</span> <span class="pre">~</span> <span class="pre">1|id</span></code> would be <em>identical</em>.  This idea is visualised below for a single block (i.e. subject <span class="math notranslate nohighlight">\(i\)</span> with covariance matrix <span class="math notranslate nohighlight">\(\boldsymbol{\Sigma}_{i}\)</span>) from an experiment with 3 time-points and 4 replications within each time-point. Hopefully this makes the distinction and its relationship with the syntax clearer.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/c89152a55e0a8e0bc9362acc32cf6ff956a2bfcd65391b6f1516fe6754036e74.png" src="_images/c89152a55e0a8e0bc9362acc32cf6ff956a2bfcd65391b6f1516fe6754036e74.png" />
</div>
</div>
<p>Note that this syntax will depend upon the type of structure used. For instance, <code class="docutils literal notranslate"><span class="pre">corCompSymm()</span></code> will ignore anything other than a <code class="docutils literal notranslate"><span class="pre">1</span></code> on the left-hand side of <code class="docutils literal notranslate"><span class="pre">|</span></code>, because a compound symmetric structure only has a single correlation for all observations within a block. So, you need to think about the <em>structure</em> you are using, how the <em>blocks</em> are defined for that structure using the term on the <em>right</em> of <code class="docutils literal notranslate"><span class="pre">|</span></code>, and how that structure is defined <em>within</em> a block using the terms on the <em>left</em> of <code class="docutils literal notranslate"><span class="pre">|</span></code>. We will see more examples of this syntax below and in the workshop this week.</p>
</section>
<section id="the-fully-unconstrained-covariance-structure">
<h3>The Fully Unconstrained Covariance Structure<a class="headerlink" href="#the-fully-unconstrained-covariance-structure" title="Link to this heading">#</a></h3>
<p>In the example above, we stuck to the restrictive assumptions of the repeated measures ANOVA and specified a covariance structure that was <em>compound symmetric</em>. However, the whole point of the GLS framework is that we can lift this assumption and specify more complex dependency structures. So, we will now consider a <em>completely unconstrained</em> covariance structure, where all correlations <em>and</em> all variances are free to vary. Note that this is the <em>opposite extreme</em> to the repeated measures ANOVA. There may well be a more appropriate structure available that is somewhere in between. For now, we will just focus on the unconstrained structure. In the accompanying workshop, we will examine some alternatives as well as how to use <em>model comparisons</em> to choose between them.</p>
<p>In order to specify a completely unconstrained structure, we need to combine both the <code class="docutils literal notranslate"><span class="pre">correlation=</span></code> option and the <code class="docutils literal notranslate"><span class="pre">weights=</span></code> option. Both of these take a <code class="docutils literal notranslate"><span class="pre">form=</span></code> argument, structured in the same way as above. For the correlation, we can use <code class="docutils literal notranslate"><span class="pre">corSymm(form=</span> <span class="pre">~</span> <span class="pre">1|id)</span></code>. This specifies a block-diagonal correlation structure, where each block consists of a completely unstructured correlation matrix. For the variance, we can use <code class="docutils literal notranslate"><span class="pre">varIdent(form=</span> <span class="pre">~</span> <span class="pre">1|time)</span></code>. This specifies a block-diagonal variance structure, where each block consists of a constant variance and the blocks are defined by the factor variable <code class="docutils literal notranslate"><span class="pre">time</span></code>. So, together, this gives us unconstrained correlation between the repeated measurements, and different variances for each level of <code class="docutils literal notranslate"><span class="pre">time</span></code>. The model is then</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">gls.mod.Unconstrained</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">gls</span><span class="p">(</span><span class="n">score</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span>
<span class="w">                             </span><span class="n">correlation</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nf">corSymm</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="o">|</span><span class="n">id</span><span class="p">),</span><span class="w"> </span>
<span class="w">                             </span><span class="n">weights</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nf">varIdent</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="o">|</span><span class="n">time</span><span class="p">),</span><span class="w"> </span>
<span class="w">                             </span><span class="n">data</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">selfesteem.long</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>and we can view the covariance matrix that has been estimated using</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Sigma.i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">getVarCov</span><span class="p">(</span><span class="n">gls.mod.Unconstrained</span><span class="p">,</span><span class="w"> </span><span class="n">individual</span><span class="o">=</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">Sigma.i</span><span class="p">)</span>
<span class="nf">image</span><span class="p">(</span><span class="nf">as</span><span class="p">(</span><span class="n">Sigma.i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Matrix&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Marginal variance covariance matrix
         [,1]     [,2]     [,3]
[1,]  0.30449 -0.12729  0.22736
[2,] -0.12729  0.74489 -0.51578
[3,]  0.22736 -0.51578  1.30550
  Standard Deviations: 0.55181 0.86307 1.1426 
</pre></div>
</div>
<img alt="_images/49a2b35fcc89cecc212ebc42f88f319b4830332f6e4c50f59523cb1158a81cbf.png" src="_images/49a2b35fcc89cecc212ebc42f88f319b4830332f6e4c50f59523cb1158a81cbf.png" />
</div>
</div>
<p>So, we can see how this syntax has allowed <em>both</em> the correlation to be unconstrained and the variances to be unconstrained. This is the <em>most general</em> covariance structure we can have for this dataset and thus represents the <em>most flexible</em> alternative to the assumptions of the repeated measures ANOVA.</p>
</section>
</section>
<section id="assumptions-and-visualisations">
<h2>Assumptions and Visualisations<a class="headerlink" href="#assumptions-and-visualisations" title="Link to this heading">#</a></h2>
<p>Before we get to discussing the tricky topic of inference, we also need to consider how to check the assumptions and visualise the GLS model. Although the plain <code class="docutils literal notranslate"><span class="pre">lm()</span></code> functions allows a variety of diagnostic plots, calling <code class="docutils literal notranslate"><span class="pre">plot()</span></code> on a GLS model will only give us a single visualisation. As such, if we want something similar we need to construct these plots ourselves, with some caveats.</p>
<section id="assumptions-plots">
<h3>Assumptions Plots<a class="headerlink" href="#assumptions-plots" title="Link to this heading">#</a></h3>
<p>In principle, all the plots we saw previously with <code class="docutils literal notranslate"><span class="pre">lm()</span></code> can still be defined using a model fit using <code class="docutils literal notranslate"><span class="pre">gls()</span></code>. However, there are two important caveats.</p>
<p>Firstly, this is true only when working with the <em>corrected</em> errors. In other words, the errors that result from <em>removing</em> the covariance structure. Technically, this means we need to assume that the covariance structure we have is <em>correct</em>, as the assumptions of the normal linear model only apply if we have managed to remove the covariance structure <em>perfectly</em>. Given that this is not going to be true under FGLS, we need to be slightly more cautious about the interpretation of these types of plots.</p>
<p>Secondly, <em>leverage</em> and <em>Cook’s Distance</em> are not defined under GLS. It may be possible to calculate some variant that is <em>similar</em> in spirit, but this is messy and would need to be scripted manually. As such, we will skip the leverage plot and, in its place, provide a visualisation of the covariance structure as a diagnostic measure, to make sure the estimated structure is as expected.</p>
<p>In the drop-down below is the definition of a function called <code class="docutils literal notranslate"><span class="pre">plot.gls()</span></code> that will create some visualisations that are similar in spirit to those from the normal linear model. These are all calculated using the residuals extracted using <code class="docutils literal notranslate"><span class="pre">resid(mod,</span> <span class="pre">type='normalized')</span></code>, which are residuals that have been <em>corrected</em> for the covariance structure and are <em>standardised</em>.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">plot.gls</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">timeseries</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">){</span>

<span class="w">  </span><span class="n">w</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">resid</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s">&quot;normalized&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">fitted</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>

<span class="w">  </span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>

<span class="w">  </span><span class="c1"># Residuals vs fitted</span>
<span class="w">  </span><span class="nf">plot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="o">=</span><span class="s">&#39;Residuals vs fitted&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="nf">lines</span><span class="p">(</span><span class="nf">lowess</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>

<span class="w">  </span><span class="c1"># Normal Q-Q</span>
<span class="w">  </span><span class="nf">qqnorm</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="nf">qqline</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Scale-Location</span>
<span class="w">  </span><span class="nf">plot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)),</span><span class="w"> </span><span class="n">main</span><span class="o">=</span><span class="s">&#39;Scale-Location&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="nf">lines</span><span class="p">(</span><span class="nf">lowess</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">w</span><span class="p">))))</span>

<span class="w">  </span><span class="c1"># Either plot of the ACF, or a visualisation of the marginal covariance structure</span>
<span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeseries</span><span class="o">==</span><span class="kc">TRUE</span><span class="p">){</span>
<span class="w">    </span><span class="nf">acf</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="w">                                   </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">getVarCov</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
<span class="w">    </span><span class="n">graphics</span><span class="o">::</span><span class="nf">image</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">V</span><span class="p">)[</span><span class="nf">nrow</span><span class="p">(</span><span class="n">V</span><span class="p">)</span><span class="o">:</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="n">main</span><span class="o">=</span><span class="s">&#39;Marginal covariance structure&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Applying this function to the results from the model with the unconstrained covariance structure gives</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot.gls</span><span class="p">(</span><span class="n">gls.mod.Unconstrained</span><span class="w"> </span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/81c38fad274650ad532deb20fd69831c1a31b9be6f7dc4b12f9c51aa2eabac41.png" src="_images/81c38fad274650ad532deb20fd69831c1a31b9be6f7dc4b12f9c51aa2eabac41.png" />
</div>
</div>
<p>As way of comparison, the model with the compound symmetric structure gives</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot.gls</span><span class="p">(</span><span class="n">gls.mod.CompSymm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ef8bd934cab9250380d47993b09596d7efb8f2649e4891f1382b210d26880673.png" src="_images/ef8bd934cab9250380d47993b09596d7efb8f2649e4891f1382b210d26880673.png" />
</div>
</div>
<p>which does appear qualitatively <em>worse</em>, thus suggesting that a more complex covariance structure provides a better model fit.</p>
</section>
<section id="visualising-the-model">
<h3>Visualising the Model<a class="headerlink" href="#visualising-the-model" title="Link to this heading">#</a></h3>
</section>
</section>
<section id="inference-using-gls">
<h2>Inference Using <code class="docutils literal notranslate"><span class="pre">gls()</span></code><a class="headerlink" href="#inference-using-gls" title="Link to this heading">#</a></h2>
<p>Finally, we get to the thorny topic of <em>inference</em> using a <code class="docutils literal notranslate"><span class="pre">gls()</span></code> model.</p>
<section id="coefficient-tests">
<h3>Coefficient Tests<a class="headerlink" href="#coefficient-tests" title="Link to this heading">#</a></h3>
<p>… The key is understanding that the <code class="docutils literal notranslate"><span class="pre">gls()</span></code> function is designed to act <em>as if</em> we were using GLS instead of FGLS. So irrespective of whether we <em>give</em> <code class="docutils literal notranslate"><span class="pre">gls()</span></code> a covariance structure or <em>estimate</em> a covariance structure, the function will act the same way. This is <strong>Option 1a</strong> from earlier in the lesson: assume <span class="math notranslate nohighlight">\(\hat{\boldsymbol{\Sigma}} = \boldsymbol{\Sigma}\)</span> and <em>ignore</em> the problem entirely. Once we understand this, the behaviour of <code class="docutils literal notranslate"><span class="pre">gls()</span></code> makes complete sense.</p>
</section>
<section id="omnibus-tests">
<h3>Omnibus Tests<a class="headerlink" href="#omnibus-tests" title="Link to this heading">#</a></h3>
</section>
<section id="follow-up-tests">
<h3>Follow-up Tests<a class="headerlink" href="#follow-up-tests" title="Link to this heading">#</a></h3>
</section>
</section>
<section id="viewing-the-complete-covariance-structure">
<h2>Viewing the Complete Covariance Structure<a class="headerlink" href="#viewing-the-complete-covariance-structure" title="Link to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">Matrix</span><span class="p">)</span>

<span class="n">gls_full_cov</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">nobs</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># Correlation blocks (list) or single matrix if no grouping</span>
<span class="w">  </span><span class="n">cs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fit</span><span class="o">$</span><span class="n">modelStruct</span><span class="o">$</span><span class="n">corStruct</span>
<span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1"># No correlation structure: R = I</span>
<span class="w">    </span><span class="n">Rlist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">Matrix</span><span class="o">::</span><span class="nf">Diagonal</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="w">    </span><span class="n">g</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="s">&quot;all&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Rlist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">corMatrix</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
<span class="w">    </span><span class="n">g</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">getGroups</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">g</span><span class="p">))</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="s">&quot;all&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1"># Variance weights (if no varStruct, all 1s)</span>
<span class="w">  </span><span class="n">vs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fit</span><span class="o">$</span><span class="n">modelStruct</span><span class="o">$</span><span class="n">varStruct</span>
<span class="w">  </span><span class="n">w</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">vs</span><span class="p">))</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="nf">varWeights</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># Indices per group, aligned to the same order as used in the fit</span>
<span class="w">  </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="nf">seq_along</span><span class="p">(</span><span class="n">g</span><span class="p">),</span><span class="w"> </span><span class="n">g</span><span class="p">)</span>

<span class="w">  </span><span class="n">sig2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fit</span><span class="o">$</span><span class="n">sigma</span><span class="o">^</span><span class="m">2</span>

<span class="w">  </span><span class="c1"># Build block covariance matrices: Sigma_g = sig2 * D^(1/2) R D^(1/2)</span>
<span class="w">  </span><span class="c1"># In nlme, varWeights are (typically) inverse-SD-type weights, so Var(e_i) = sig2 / w_i^2.</span>
<span class="w">  </span><span class="n">Sig_blocks</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">Map</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Dhalf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Matrix</span><span class="o">::</span><span class="nf">Diagonal</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">w</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
<span class="w">    </span><span class="n">sig2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Dhalf</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">Dhalf</span><span class="p">)</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="n">Rlist</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span>

<span class="w">  </span><span class="n">Matrix</span><span class="o">::</span><span class="nf">bdiag</span><span class="p">(</span><span class="n">Sig_blocks</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">image</span><span class="p">(</span><span class="nf">gls_full_cov</span><span class="p">(</span><span class="n">gls.mod.Unconstrained</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1fd569bbcec7c3b84c916e0b3c704874f5641b652309a4a891a8f2463f25c1ed.png" src="_images/1fd569bbcec7c3b84c916e0b3c704874f5641b652309a4a891a8f2463f25c1ed.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            name: "ir",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="3.gls.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Generalised Least Squares (GLS)</p>
      </div>
    </a>
    <a class="right-next"
       href="5.gls-limitations.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Limitations of the GLS Framework</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-gls-one-way-anova">The GLS One-way ANOVA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-data">The Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-gls-syntax">The <code class="docutils literal notranslate"><span class="pre">gls()</span></code> Syntax</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-form-syntax">Understanding the <code class="docutils literal notranslate"><span class="pre">form=</span></code> Syntax</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-fully-unconstrained-covariance-structure">The Fully Unconstrained Covariance Structure</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assumptions-and-visualisations">Assumptions and Visualisations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assumptions-plots">Assumptions Plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualising-the-model">Visualising the Model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inference-using-gls">Inference Using <code class="docutils literal notranslate"><span class="pre">gls()</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coefficient-tests">Coefficient Tests</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#omnibus-tests">Omnibus Tests</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#follow-up-tests">Follow-up Tests</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#viewing-the-complete-covariance-structure">Viewing the Complete Covariance Structure</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dr Martyn McFarquhar
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2026.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>